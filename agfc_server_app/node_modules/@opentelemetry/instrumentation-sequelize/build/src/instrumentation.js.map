{"version":3,"file":"instrumentation.js","sourceRoot":"","sources":["../../src/instrumentation.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright The OpenTelemetry Authors, Aspecto\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  context,\n  Span,\n  SpanKind,\n  SpanStatusCode,\n  trace,\n  diag,\n  Attributes,\n} from '@opentelemetry/api';\nimport { suppressTracing } from '@opentelemetry/core';\nimport {\n  ATTR_DB_COLLECTION_NAME,\n  ATTR_DB_OPERATION_NAME,\n  ATTR_DB_NAMESPACE,\n  ATTR_DB_QUERY_TEXT,\n  ATTR_DB_SYSTEM_NAME,\n  ATTR_SERVER_ADDRESS,\n  ATTR_SERVER_PORT,\n  ATTR_NETWORK_TRANSPORT,\n  NETWORK_TRANSPORT_VALUE_TCP,\n} from '@opentelemetry/semantic-conventions';\nimport type * as sequelize from 'sequelize';\nimport { SequelizeInstrumentationConfig } from './types';\n/** @knipignore */\nimport { PACKAGE_NAME, PACKAGE_VERSION } from './version';\nimport { extractTableFromQuery } from './utils';\nimport {\n  InstrumentationBase,\n  InstrumentationNodeModuleDefinition,\n  InstrumentationNodeModuleFile,\n  isWrapped,\n  safeExecuteInTheMiddle,\n} from '@opentelemetry/instrumentation';\n\nexport class SequelizeInstrumentation extends InstrumentationBase<SequelizeInstrumentationConfig> {\n  static readonly component = 'sequelize';\n  static readonly supportedVersions = '>=6 <7';\n\n  constructor(config: SequelizeInstrumentationConfig = {}) {\n    super(PACKAGE_NAME, PACKAGE_VERSION, config);\n  }\n\n  protected init() {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const unpatchConnectionManager = (moduleExports: any) => {\n      if (\n        isWrapped(moduleExports?.ConnectionManager?.prototype?.getConnection)\n      ) {\n        this._unwrap(\n          moduleExports.ConnectionManager.prototype,\n          'getConnection'\n        );\n      }\n      return moduleExports;\n    };\n    const connectionManagerInstrumentation = new InstrumentationNodeModuleFile(\n      'sequelize/lib/dialects/abstract/connection-manager.js',\n      [SequelizeInstrumentation.supportedVersions],\n      moduleExports => {\n        if (moduleExports === undefined || moduleExports === null) {\n          return moduleExports;\n        }\n        unpatchConnectionManager(moduleExports);\n        this._wrap(\n          moduleExports.ConnectionManager.prototype,\n          'getConnection',\n          this._getConnectionPatch()\n        );\n        return moduleExports;\n      },\n      unpatchConnectionManager\n    );\n\n    const unpatch = (moduleExports: typeof sequelize) => {\n      if (isWrapped(moduleExports.Sequelize.prototype.query)) {\n        this._unwrap(moduleExports.Sequelize.prototype, 'query');\n      }\n    };\n    const module = new InstrumentationNodeModuleDefinition(\n      SequelizeInstrumentation.component,\n      [SequelizeInstrumentation.supportedVersions],\n      moduleExports => {\n        if (moduleExports === undefined || moduleExports === null) {\n          return moduleExports;\n        }\n\n        unpatch(moduleExports);\n        this._wrap(\n          moduleExports.Sequelize.prototype,\n          'query',\n          this._createQueryPatch()\n        );\n\n        return moduleExports;\n      },\n      unpatch,\n      [connectionManagerInstrumentation]\n    );\n    return module;\n  }\n\n  // run getConnection with suppressTracing, as it might call internally to `databaseVersion` function\n  // which calls `query` and create internal span which we don't need to instrument\n  private _getConnectionPatch() {\n    return (original: Function) => {\n      return function (this: unknown, ...args: unknown[]) {\n        return context.with(suppressTracing(context.active()), () =>\n          original.apply(this, args)\n        );\n      };\n    };\n  }\n\n  private _createQueryPatch() {\n    const self = this;\n    return (original: sequelize.Sequelize['query']) => {\n      return function query(\n        this: sequelize.Sequelize,\n        ...args: Parameters<sequelize.Sequelize['query']>\n      ) {\n        if (\n          self.getConfig().ignoreOrphanedSpans &&\n          !trace.getSpan(context.active())\n        ) {\n          return original.apply(this, args);\n        }\n\n        const sqlOrQuery = args[0];\n        const extractStatement = (sql: typeof sqlOrQuery) => {\n          if (typeof sql === 'string') return sql;\n          return sql?.query || '';\n        };\n        const statement = extractStatement(args[0]).trim();\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        const option = args[1] as any;\n        let operation = option?.type;\n\n        if (!operation) operation = statement.split(' ')[0];\n\n        const sequelizeInstance: sequelize.Sequelize = this;\n        const config = sequelizeInstance?.config;\n\n        let tableName = option?.instance?.constructor?.tableName;\n        if (!tableName) {\n          if (Array.isArray(option?.tableNames) && option.tableNames.length > 0)\n            tableName = option?.tableNames.sort().join(',');\n          else tableName = extractTableFromQuery(statement);\n        }\n\n        const attributes: Attributes = {\n          [ATTR_DB_SYSTEM_NAME]: sequelizeInstance.getDialect(),\n          [ATTR_DB_NAMESPACE]: config?.database,\n          [ATTR_DB_OPERATION_NAME]: operation,\n          [ATTR_DB_QUERY_TEXT]: statement,\n          [ATTR_DB_COLLECTION_NAME]: tableName,\n          [ATTR_SERVER_ADDRESS]: config?.host,\n          [ATTR_SERVER_PORT]: config?.port ? Number(config?.port) : undefined,\n          [ATTR_NETWORK_TRANSPORT]: self._getNetTransport(config?.protocol),\n        };\n\n        const newSpan: Span = self.tracer.startSpan(`Sequelize ${operation}`, {\n          kind: SpanKind.CLIENT,\n          attributes,\n        });\n\n        const activeContextWithSpan = trace.setSpan(context.active(), newSpan);\n\n        const hook = self.getConfig().queryHook;\n        if (hook !== undefined && sqlOrQuery !== undefined) {\n          safeExecuteInTheMiddle(\n            () => hook(newSpan, { sql: sqlOrQuery, option }),\n            e => {\n              if (e)\n                diag.error('sequelize instrumentation: queryHook error', e);\n            },\n            true\n          );\n        }\n\n        return (\n          context\n            .with(\n              self.getConfig().suppressInternalInstrumentation\n                ? suppressTracing(activeContextWithSpan)\n                : activeContextWithSpan,\n              () => original.apply(this, args)\n            )\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            .then((response: any) => {\n              const responseHook = self.getConfig().responseHook;\n              if (responseHook !== undefined) {\n                safeExecuteInTheMiddle(\n                  () => responseHook(newSpan, response),\n                  e => {\n                    if (e)\n                      diag.error(\n                        'sequelize instrumentation: responseHook error',\n                        e\n                      );\n                  },\n                  true\n                );\n              }\n              return response;\n            })\n            .catch((err: Error) => {\n              newSpan.setStatus({\n                code: SpanStatusCode.ERROR,\n                message: err.message,\n              });\n              throw err;\n            })\n            .finally(() => {\n              newSpan.end();\n            })\n        );\n      };\n    };\n  }\n\n  private _getNetTransport(protocol: string) {\n    switch (protocol) {\n      case 'tcp':\n        return NETWORK_TRANSPORT_VALUE_TCP;\n      default:\n        return undefined;\n    }\n  }\n}\n"]}